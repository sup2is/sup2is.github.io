---
layout: post
title: "Java의 Exception 그리고 Spring의 @Transactional"
tags: [Java, Spring, Exception, CheckedException, UnCheckedException, @Transactional]
date: 2021-02-24
comments: true
---

<br>



# Overview

이번시간에는 자바의 Exception 종류인 `CheckedException`, `UnCheckedException`, `Error`에 대해서 알아보고 Spring `@Transactional`에서 각가 에러들이 어떤식으로 처리되는지 알아보는 시간을 갖도록 하겠다.





# Java의 Exceptions

자바에는 크게 3가지 종류의 Exception이 있다. `CheckedException`, `UnCheckedException`, `Error` 이 Exception들을 알아보기 전에 최상위 클래스가 되는 `Throwable`을 먼저 알아보도록 하자.



## Throwable

이 `Throwable` 클래스는 자바의 모든 에러, 예외들의 최상위 클래스이다. 큰 분류로 나누었을때, 하위 클래스들은 다음과 같은 관계도를 가진다.

![20210303_155912](https://user-images.githubusercontent.com/30790184/109766400-74d49100-7c39-11eb-93b8-3cd169c44c2f.png)

`Throwable`은 생성 당시에 스레드의 실행 스냅샷을 포함하고 오류에 대한 자세한 메시지,  중첩된 `Throwable` 형태로 설계되었다. 실제 `Throwable` 생성자 목록은 아래와 같은 모습으로 설계되었다.

- ### Constructor Summary

  | Modifier    | Constructor                                                  | Description                                                  |
  | :---------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
  | ` `         | `Throwable()`                                                | Constructs a new throwable with `null` as its detail message. |
  | ` `         | `Throwable(String message)`                                  | Constructs a new throwable with the specified detail message. |
  | ` `         | `Throwable(String message, Throwable cause)`                 | Constructs a new throwable with the specified detail message and cause. |
  | `protected` | `Throwable(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace)` | Constructs a new throwable with the specified detail message, cause, [suppression](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Throwable.html#addSuppressed(java.lang.Throwable)) enabled or disabled, and writable stack trace enabled or disabled. |
  | ` `         | `Throwable(Throwable cause)`                                 | Constructs a new throwable with the specified cause and a detail message of `(cause==null ? null : cause.toString())` (which typically contains the class and detail message of `cause`). |



## CheckedExecption

`CheckedExecption`은 Java 컴파일러가 처리해야 하는 예외이다. `throw` 키워드를 사용해서 선언적으로 예외를 던지거나 `try-catch` 형태로 예외를 직접 처리해야 한다는 의미이다. Java에서 `CheckedExecption`은 대부분 `Exception` 클래스를 상속하는 클래스들이고 사용하는  대표적으로 `IOException`, `ServletException` 등이 있다. 

`Exception`클래스를 상속받는 다양한 `CheckedExecption`은 [https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Exception.html](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Exception.html)에서 직접 확인할 수 있다.

이 `CheckedExecption`은 클라이언트가 예외에서 복구할 것으로 예측할수 있을때 사용하기 적합한 Exception 타입이다.

![20210303_153613](https://user-images.githubusercontent.com/30790184/109765198-dac01900-7c37-11eb-9000-1aef5cbe7501.png)

> 예외를 처리하지 않으면 컴파일러가 에러를 보여줌.



## UnCheckedException

`UnCheckedException`은 Java 컴파일러가 처리할 필요가 없는 예외이다. 간단하게 설명하면 컴파일러가 신경쓰지 않기 때문에 별도의 예외처리를 해주지 않아도 된다. Java에서 `UnCheckedException`은 `RuntimeException` 또는 `Error` 클래스를 상속하는 클래스들이고 대표적으로 `NullPointerException`, `IllegalArgumentException` 등이 있다. 

`RuntimeException`을 상속받는 클래스들은 [https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/RuntimeException.html](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/RuntimeException.html)에서, `Error` 클래스를 상속받는 클래스들은 [https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Error.html](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Error.html) 에서 확인할 수 있다.

이 `UnCheckedException`은 클라이언트가 예외를 만난다고 하더라도 복구하기위해 아무것도 할 수 없을때 사용하기 적합한 Exception 타입이다.



![20210303_153626](https://user-images.githubusercontent.com/30790184/109765195-d98eec00-7c37-11eb-91d6-681f272ade68.png)

> 별도의 예외 처리 없이 컴파일 할 수 있음



## Error

`Error`는 라이브러리 비 호환성, 무한 재귀 또는 메모리 누수와 같은 심각하고 일반적으로 복구 할 수없는 상태를 나타낸다. 위에서 설명했듯이 `Error`를 상속하는 모든 클래스들은 `UnCheckedException` 형태로 동작한다.

대표적인 `Error`클래스들로 `OutOfMemoryError`, `StackOverflowError`  등이 있다.





> Java에서는 `try-catch` 또는 `throws` 관련 예약어를 통해서 예외를 처리할 수 있다. 예외를 처리하는 자세한 정보는 [https://www.baeldung.com/java-exceptions#handling-exceptions](https://www.baeldung.com/java-exceptions#handling-exceptions) 에서 찾아볼 수 있고 그 외에도 안티패턴, `finally`에 대한 내용도 있으니 확인해보면 좋을 것 같다.



# Spring @Transactional과 Exception

이제 위에서 알아본 Java의 Exception 종류들 중 `UnCheckedException`과 `CheckedException`에 따라 다르게 동작하는 `@Transactional`애너테이션에 대해서 알아보도록 하자.



## @Transactional

Spring에서는 `@Transactional`이란 애너테이션을 사용해서 트랜잭션 처리를 한다. 내부적으로 프록시 객체를 생성해서 실행되는 메서드 전후에 트랜잭션과 관련된 로직을 삽입하여 Exception이 발생하면 rollback을 시키고 예상대로 잘 동작한 경우 commit을 한다.

하지만 여기서 정확하게 짚고 넘어가면 모든 Exception 타입이 아닌 `UnCheckedException`만 rollback을 시킨다.

> #### rollbackFor
>
> ```
> public abstract Class<? extends Throwable>[] rollbackFor
> ```
>
> Defines zero (0) or more exception [`classes`](https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html?is-external=true), which must be subclasses of [`Throwable`](https://docs.oracle.com/javase/8/docs/api/java/lang/Throwable.html?is-external=true), indicating which exception types must cause a transaction rollback.
>
> By default, a transaction will be rolling back on [`RuntimeException`](https://docs.oracle.com/javase/8/docs/api/java/lang/RuntimeException.html?is-external=true) and [`Error`](https://docs.oracle.com/javase/8/docs/api/java/lang/Error.html?is-external=true) but not on checked exceptions (business exceptions). See [`DefaultTransactionAttribute.rollbackOn(Throwable)`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/interceptor/DefaultTransactionAttribute.html#rollbackOn-java.lang.Throwable-) for a detailed explanation.
>
> This is the preferred way to construct a rollback rule (in contrast to [`rollbackForClassName()`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html#rollbackForClassName--)), matching the exception class and its subclasses.
>
> Similar to [`RollbackRuleAttribute(Class clazz)`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/interceptor/RollbackRuleAttribute.html#RollbackRuleAttribute-java.lang.Class-).
>
> - **See Also:**
>
>   [`rollbackForClassName()`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html#rollbackForClassName--), [`DefaultTransactionAttribute.rollbackOn(Throwable)`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/interceptor/DefaultTransactionAttribute.html#rollbackOn-java.lang.Throwable-)
>
> - Default:
>
>   {}



예를 들어 다음과 같은 상황이 있다고 가정해보자

1. 사용자에게 List 형태의 데이터를 입력받는다.
2. 사용자이름 앞에는 `#` 접두어가 있어야 반드시 저장되고 아닐경우 `DataFormatException` 예외를 발생시킨다.

```

```





# 마무리

이번 시간에는 Elasticsearch의 간단한 특징과 사용방법에 대해서 알아봤다. 다음시간에는 Elasticsearch의 기본 개념들인 클러스터, 노드, 샤드, 세그먼트들에 대해서 알아보는 시간을 가져보도록 하겠다.



<br>

***

포스팅은 여기까지 하겠습니다. 퍼가실때는 출처를 반드시 남겨주세요!

<br>

**References**

- [https://www.baeldung.com/java-exceptions](https://www.baeldung.com/java-exceptions)
- [https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Throwable.html](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Throwable.html)
- [https://docs.oracle.com/javase/tutorial/essential/exceptions/runtime.html](https://docs.oracle.com/javase/tutorial/essential/exceptions/runtime.html)
- [https://www.cloudflight.io/tech/spring-transactional-no-rollback-1691/](https://www.cloudflight.io/tech/spring-transactional-no-rollback-1691/)

